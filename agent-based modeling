import numpy as np
import matplotlib.pyplot as plt
import random

# States
SUSCEPTIBLE = 0
INFECTED = 1
RECOVERED = 2
DEAD = 3

class Agent:
    def __init__(self, x, y, state=SUSCEPTIBLE):
        self.x = x
        self.y = y
        self.state = state
        self.infected_time = 0

class EpidemicSimulation:
    def __init__(self, grid_size=50, population=500, beta=0.3, recovery_time=20, mortality=0.02):
        self.grid_size = grid_size
        self.beta = beta
        self.recovery_time = recovery_time
        self.mortality = mortality
        self.grid = np.full((grid_size, grid_size), None)
        self.agents = []
        self.history = []

        self._init_population(population)

    def _init_population(self, population):
        positions = random.sample([(i, j) for i in range(self.grid_size) for j in range(self.grid_size)], population)
        for idx, (x, y) in enumerate(positions):
            state = INFECTED if idx == 0 else SUSCEPTIBLE
            agent = Agent(x, y, state)
            self.agents.append(agent)
            self.grid[x, y] = agent

    def neighbors(self, agent):
        dirs = [(-1,0),(1,0),(0,-1),(0,1)]
        result = []
        for dx, dy in dirs:
            nx, ny = agent.x + dx, agent.y + dy
            if 0 <= nx < self.grid_size and 0 <= ny < self.grid_size:
                neighbor = self.grid[nx, ny]
                if neighbor is not None:
                    result.append(neighbor)
        return result

    def move_agent(self, agent):
        dirs = [(-1,0),(1,0),(0,-1),(0,1)]
        random.shuffle(dirs)
        for dx, dy in dirs:
            nx, ny = agent.x + dx, agent.y + dy
            if 0 <= nx < self.grid_size and 0 <= ny < self.grid_size:
                if self.grid[nx, ny] is None:
                    self.grid[agent.x, agent.y] = None
                    agent.x, agent.y = nx, ny
                    self.grid[nx, ny] = agent
                    break

    def step(self):
        random.shuffle(self.agents)

        for agent in self.agents:
            if agent.state != DEAD:
                self.move_agent(agent)

        for agent in self.agents:
            if agent.state == SUSCEPTIBLE:
                for n in self.neighbors(agent):
                    if n.state == INFECTED and random.random() < self.beta:
                        agent.state = INFECTED
                        break

            elif agent.state == INFECTED:
                agent.infected_time += 1
                if agent.infected_time >= self.recovery_time:
                    if random.random() < self.mortality:
                        agent.state = DEAD
                        self.grid[agent.x, agent.y] = None
                    else:
                        agent.state = RECOVERED

        self.record()

    def record(self):
        counts = {SUSCEPTIBLE:0, INFECTED:0, RECOVERED:0, DEAD:0}
        for agent in self.agents:
            counts[agent.state] += 1
        self.history.append(counts)

    def run(self, steps=200):
        for _ in range(steps):
            self.step()

    def plot(self):
        s = [h[SUSCEPTIBLE] for h in self.history]
        i = [h[INFECTED] for h in self.history]
        r = [h[RECOVERED] for h in self.history]
        d = [h[DEAD] for h in self.history]

        plt.figure(figsize=(8,5))
        plt.plot(s, label='Susceptible')
        plt.plot(i, label='Infected')
        plt.plot(r, label='Recovered')
        plt.plot(d, label='Dead')
        plt.xlabel('Time steps')
        plt.ylabel('Population')
        plt.legend()
        plt.tight_layout()
        plt.show()


if __name__ == '__main__':
    sim = EpidemicSimulation()
    sim.run()
    sim.plot()
